

      if(name === "") {
        alert("الرجاء ملء حقل اسم الموظف.");
        nameInput.focus();
        return;
      }
      if(finalReason === "" && selectedMode === "manual") {
         alert("الرجاء إدخال سبب الإنذار في النمط اليدوي.");
         document.getElementById("manualReason").focus();
         return;
      }
       if(finalReason === "" && (selectedMode === "ai" || selectedMode.startsWith("custom_"))) {
         alert("لم يتمكن النظام من توليد سبب. يرجى التحقق من الإعدادات أو اختيار نمط يدوي.");
         return;
      }

      const typeSelect = document.getElementById("type");
      const type = typeSelect.value;
      const typeNumber = typeNumberInput.value.trim();
      const today = new Date();
      const date = today.toLocaleDateString('fr-CA');
      const [year, month, day] = date.split('-');
      const formattedDate = [day, month, year].join('/');

      const alertObj = { name: name, reason: finalReason, type: type, date: formattedDate, typeNumber: typeNumber, id: Date.now().toString() };

      if(editingIndex !== -1 && alerts[editingIndex]) {
        alertObj.id = alerts[editingIndex].id;
        alerts[editingIndex] = alertObj;
        editingIndex = -1;
        addBtn.innerHTML = '<i class="fas fa-plus"></i> إضافة';
      } else {
        alerts.unshift(alertObj);
      }
      saveAlertsToLocalStorage();
      updateAlertsModalList();

      let successModalEl = document.getElementById("successModal");
      let successModal = bootstrap.Modal.getInstance(successModalEl);
      if (!successModal) {
        successModal = new bootstrap.Modal(successModalEl);
      }
      successModal.show();

      if (typeof employeeNames !== 'undefined' && !employeeNames.some(empName => empName.toLowerCase() === name.toLowerCase()) && editingIndex === -1) {
        if (confirm(`الموظف "${name}" غير موجود في قائمة الاقتراحات. هل ترغب في إضافته الآن؟`)) {
            if (!employeeNames.some(empName => empName.toLowerCase() === name.toLowerCase())) { 
                employeeNames.push(name);
                employeeNames.sort((a, b) => a.localeCompare(b, 'ar'));
                saveEmployeeNames();
                updateEmployeeDatalist();
                updateEmployeeList();
                alert(`تم إضافة الموظف "${name}" إلى قائمة الاقتراحات.`);
            }
        }
      }

      nameInput.value = "";
      document.getElementById("aiReason").value = "";
      document.getElementById("manualReason").value = "";
      typeNumberInput.value = "";
      document.getElementById("reasonMode").value = "manual";
      document.getElementById("reasonMode").dispatchEvent(new Event('change'));
      if (typeSelect.options.length > 0) typeSelect.selectedIndex = 0;
      nameInput.focus();
    }


    function deleteAlert(alertId) {
      if (!confirm("هل أنت متأكد من رغبتك في حذف هذا التنبيه؟ لا يمكن التراجع عن هذا الإجراء.")) return;
      alerts = alerts.filter(alert => alert.id !== alertId);
      updateAlertsModalList();
      saveAlertsToLocalStorage();
    }

    function editAlert(alertId) {
        const alertIndexToEdit = alerts.findIndex(alert => alert.id === alertId);
        if (alertIndexToEdit === -1) return;

        editingIndex = alertIndexToEdit;
        const alertObj = alerts[alertIndexToEdit];

        nameInput.value = alertObj.name;
        document.getElementById("type").value = alertObj.type;
        typeNumberInput.value = alertObj.typeNumber || "";

        let violationDisplayNameForAIRule = (violationTypes.find(v => v.id === alertObj.type) || {}).name || alertObj.type;
        let expectedAIRule = defaultAIRule.replace(/{violationType}/g, violationDisplayNameForAIRule).replace(/{name}/g, alertObj.name);

        let reasonMatched = false;
        if (expectedAIRule === alertObj.reason) {
            document.getElementById("reasonMode").value = "ai";
            reasonMatched = true;
        } else {
            for (const pattern of customPatterns) {
                let currentNameForPattern = nameInput.value.trim();
                let patternTextWithCurrentName = pattern.text.replace(/{name}/g, currentNameForPattern || "الموظف")
                                                             .replace(/\bname\b/g, currentNameForPattern || "الموظف");
                if (patternTextWithCurrentName === alertObj.reason) {
                    document.getElementById("reasonMode").value = "custom_" + pattern.id;
                    reasonMatched = true;
                    break;
                }
            }
        }

        document.getElementById("reasonMode").dispatchEvent(new Event('change'));

        if (reasonMatched) {
            document.getElementById("aiReason").value = alertObj.reason;
        } else {
            document.getElementById("reasonMode").value = "manual";
            document.getElementById("reasonMode").dispatchEvent(new Event('change'));
            document.getElementById("manualReason").value = alertObj.reason;
        }

        addBtn.innerHTML = '<i class="fas fa-save"></i> حفظ التعديل';
        nameInput.focus();
    }

    const PRINT_SETTINGS_KEY = 'printSettings_EmperMI_v1';
    let printSettings = {
        companyNote: `📌 <strong>ملاحظة توضيحية:</strong><br>
    نحن شركة كيب شوز نعلمكم أن الغرامات التي نقتطعها من العمال تُعتبر وسيلة لتحفيزهم على الانضباط والعمل بجدية أكبر. عليه، فإن العامل الذي لا تُسجل عليه أي غرامات ويُظهر التزامًا ملحوظًا، يستفيد من زيادة مالية قدرها 500 دج مكافأة له على سلوكه المهني الجيد.`,
        disclaimerNote: `📎 <strong>تنويه:</strong><br>
    في حال عدم التوقيع على هذه الوثيقة خلال المهلة المحددة، سيتم تفعيل الوضع الثاني تلقائيًا، وتُعتبر الوثيقة ممضية بصفة آلية بعد مرور أربع (4) ساعات من تاريخ تسليمها.`,
        printTitleColorGlobal: 'auto',
        qrExtraText: '' 
    };

    function loadPrintSettings() {
        const storedSettings = localStorage.getItem(PRINT_SETTINGS_KEY);
        if (storedSettings) {
            try {
                const parsedSettings = JSON.parse(storedSettings);
                printSettings = {
                    companyNote: (parsedSettings.companyNote !== undefined) ? parsedSettings.companyNote : printSettings.companyNote,
                    disclaimerNote: (parsedSettings.disclaimerNote !== undefined) ? parsedSettings.disclaimerNote : printSettings.disclaimerNote,
                    printTitleColorGlobal: parsedSettings.printTitleColorGlobal || 'auto',
                    qrExtraText: parsedSettings.qrExtraText || '' 
                };
            } catch (e) {
                console.error("Error parsing print settings, using defaults.", e);
            }
        }
        const companyNoteEl = document.getElementById("printCompanyNote");
        const disclaimerNoteEl = document.getElementById("printDisclaimerNote");
        const globalColorEl = document.getElementById("printTitleColorGlobal");
        const qrExtraTextEl = document.getElementById("printQrExtraText"); 


        if (companyNoteEl) companyNoteEl.value = printSettings.companyNote;
        if (disclaimerNoteEl) disclaimerNoteEl.value = printSettings.disclaimerNote;
        if (globalColorEl) globalColorEl.value = printSettings.printTitleColorGlobal;
        if (qrExtraTextEl) qrExtraTextEl.value = printSettings.qrExtraText; 
    }

    function savePrintSettings() {
        localStorage.setItem(PRINT_SETTINGS_KEY, JSON.stringify(printSettings));
    }

    function updateAndSavePrintSettings() {
        const companyNoteEl = document.getElementById("printCompanyNote");
        const disclaimerNoteEl = document.getElementById("printDisclaimerNote");
        const globalColorEl = document.getElementById("printTitleColorGlobal");
        const qrExtraTextEl = document.getElementById("printQrExtraText"); 

        if (companyNoteEl) printSettings.companyNote = companyNoteEl.value.trim();
        if (disclaimerNoteEl) printSettings.disclaimerNote = disclaimerNoteEl.value.trim();
        if (globalColorEl) printSettings.printTitleColorGlobal = globalColorEl.value;
        if (qrExtraTextEl) printSettings.qrExtraText = qrExtraTextEl.value.trim(); 

        savePrintSettings();
        alert("تم حفظ إعدادات الطباعة بنجاح!");
    }

    function printAlert(alertObj) {
      const printWindow = window.open('', '_blank', 'width=800,height=750,scrollbars=yes,resizable=yes');
      let vt = violationTypes.find(v => v.id === alertObj.type);
      let violationName = vt ? vt.name : alertObj.type;

      let titleColorClass = '';
      const globalColorSetting = printSettings.printTitleColorGlobal;

      if (globalColorSetting === 'auto' || !globalColorSetting) {
          if (vt) {
              const vtNameLower = vt.name.toLowerCase();
              if (vtNameLower.includes("مكافأة") || vtNameLower.includes("شكر")) {
                  titleColorClass = `print-title-green`;
              } else if (vtNameLower.includes("إنذار") || vtNameLower.includes("تنبيه") || vtNameLower.includes("توبيخ") || vtNameLower.includes("لفت نظر")) {
                  titleColorClass = `print-title-orange`;
              } else { 
                  titleColorClass = `print-title-red`;
              }
          } else {
             titleColorClass = `print-title-red`;
          }
      } else {
          titleColorClass = `print-title-${globalColorSetting}`;
      }

      let qrDataString =
        `النوع: ${violationName} ${alertObj.typeNumber ? '(رقم: ' + alertObj.typeNumber + ')' : ''}\n` +
        `الموظف: ${alertObj.name}\n` +
        `السبب: ${alertObj.reason}\n` +
        `التاريخ: ${alertObj.date}`;
      
      if (printSettings.qrExtraText && printSettings.qrExtraText.trim() !== "") {
        qrDataString += `\n\nنص إضافي:\n${printSettings.qrExtraText.trim()}`;
      }

      const encodedQrData = encodeURIComponent(qrDataString);
      const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodedQrData}&ecc=M&margin=2`;

      const combinedFooterNote = `${printSettings.companyNote}<br><br>${printSettings.disclaimerNote}`;

      const generatePrintContent = (uniqueIdSuffix) => {
        return `
          <div class="print-area">
            <h2 class="print-title">
              <span class="${titleColorClass}">
                ${violationName} ${alertObj.typeNumber ? '(' + alertObj.typeNumber + ')' : ''}
              </span>
            </h2>
            <p class="print-alert-message">
              ${alertObj.reason}
            </p>
            <div class="print-footer-content">
                <div class="footer-top-line">
                    <p class="print-date-custom">التاريخ: ${alertObj.date}</p>
                    <p class="print-signature-custom">إمضاء</p>
                </div>
                <div class="qr-and-note-area">
                    <div class="company-note-print">
                        ${combinedFooterNote}
                    </div>
                    <div class="qr-code-container-print">
                      <img id="qrImage-${uniqueIdSuffix}" src="${qrApiUrl}" alt="QR Code" class="qrcode-img-custom" />
                    </div>
                </div>
            </div>
          </div>
        `;
      };

      printWindow.document.write(`
        <html>
          <head>
            <title>طباعة الإنذار/العقوبة - نسختان</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
            <style>
              @media print {
                @page {
                  size: A4;
                  margin: 10mm;
                }
                body {
                  font-family: 'Tajawal', sans-serif;
                  direction: rtl;
                  margin: 0;
                  padding: 0;
                  background-color: #fff !important;
                  -webkit-print-color-adjust: exact !important;
                  print-color-adjust: exact !important;
                }
                .print-area {
                  padding: 7mm;
                  border: 1.5px solid #000;
                  margin: 0 auto 7mm auto;
                  min-height: 128mm;
                  max-height: 133mm;
                  overflow: hidden;
                  width: 100%;
                  box-sizing: border-box;
                  background-color: #fff !important;
                  display: flex;
                  flex-direction: column;
                }
                .print-area:last-of-type {
                    margin-bottom: 0;
                }

                .print-title { text-align: center; font-size: 1.3em; margin-bottom: 4mm; font-weight: bold; }
                
                /* MODIFIED: Print alert message styling for better text flow */
                .print-alert-message {
                    text-align: right; 
                    font-size: 1.0em;  
                    line-height: 1.5;  
                    margin-bottom: 4mm; 
                    min-height: 25mm;
                    flex-grow: 1;
                    padding: 0 5mm; 
                    word-break: normal; 
                    overflow-wrap: break-word; 
                    hyphens: auto; 
                    -webkit-hyphens: auto;
                    -ms-hyphens: auto;
                }
                /* END MODIFIED */

                .print-footer-content {
                    margin-top: auto;
                }
                .footer-top-line {
                    display: flex;
                    justify-content: space-between;
                    align-items: baseline;
                    margin-bottom: 20mm;
                }
                .print-date-custom {
                    font-size: 0.95em;
                    line-height: 1.3;
                    margin: 0;
                }
                .print-signature-custom {
                    font-size: 1.05em;
                    line-height: 1.4;
                    margin: 0;
                }
                .qr-and-note-area {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-end;
                    margin-top: 2mm;
                    width: 100%;
                }
                .company-note-print {
                    flex-basis: 70%;
                    font-size: 0.8em;
                    line-height: 1.4;
                    text-align: justify;
                    padding-left: 4mm; 
                }
                html[dir="rtl"] .company-note-print {
                    padding-left: 0;
                    padding-right: 4mm;
                }
                .company-note-print strong { font-weight: bold; }

                .qr-code-container-print {
                    flex-shrink: 0;
                    text-align: right; 
                }
                 html[dir="rtl"] .qr-code-container-print {
                    text-align: left;
                }
                .qrcode-img-custom {
                    width: 120px;
                    height: 120px;
                    display: block;
                    border: none;
                }

                .print-title-red { color: red !important; }
                .print-title-orange { color: orange !important; }
                .print-title-green { color: green !important; }
                .print-title-blue { color: var(--primary-color) !important; }
                .print-title-black { color: black !important; }


                hr.print-separator {
                    border: none;
                    border-top: 1px dashed #888;
                    margin: 5mm auto;
                    width: 95%;
                    page-break-before: auto !important;
                    page-break-after: auto !important;
                }
              }
              body:not(:global(*)) {
                font-family: 'Tajawal', sans-serif;
                direction: rtl;
                margin: 10px;
              }
              body:not(:global(*)) .print-area {
                 border: 2px solid #ccc; margin-bottom: 20px; padding: 20px;
              }
              body:not(:global(*)) hr.print-separator {
                 margin: 20px 0; border-top: 1px dashed #aaa;
              }
            </style>
          </head>
          <body>
            ${generatePrintContent('1')}
            <hr class="print-separator">
            ${generatePrintContent('2')}
          </body>
        </html>
      `);
      printWindow.document.close();

      printWindow.onload = function() {
          let images = printWindow.document.querySelectorAll('.qrcode-img-custom');
          let imagesLoaded = 0;
          const totalImages = images.length;
          let printHasBeenTriggered = false;

          const attemptPrint = () => {
              if (printHasBeenTriggered) return;
              printHasBeenTriggered = true;
              printWindow.focus();
              printWindow.print();
          };

          if (totalImages === 0) {
              setTimeout(attemptPrint, 500);
              return;
          }

          images.forEach(img => {
              if (img.complete && img.naturalHeight !== 0) {
                  imagesLoaded++;
              } else {
                  img.onload = () => {
                      imagesLoaded++;
                      if (imagesLoaded === totalImages) {
                          attemptPrint();
                      }
                  };
                  img.onerror = () => {
                      imagesLoaded++;
                      const placeholder = printWindow.document.createElement('div');
                      placeholder.textContent = 'خطأ تحميل QR';
                      placeholder.style.cssText = 'width:120px; height:120px; border:1px solid red; text-align:center; padding-top:50px; display:block; box-sizing:border-box; font-size:10px;';
                      if (img.parentNode) {
                        img.parentNode.replaceChild(placeholder, img);
                      }
                      if (imagesLoaded === totalImages) {
                          attemptPrint();
                      }
                  };
              }
          });

          if (imagesLoaded === totalImages && totalImages > 0) {
             attemptPrint();
          }

          setTimeout(() => {
              if (!printHasBeenTriggered) {
                 attemptPrint();
              }
          }, 3500);
      };
    }

    function updateAlertsModalList() {
      let modalList = document.getElementById("alertsModalList");
      modalList.innerHTML = "";
      let searchValue = document.getElementById("modalSearchInput").value.trim().toLowerCase();
      let filteredAlerts = alerts.filter(alertObj =>
        alertObj.name.toLowerCase().includes(searchValue) ||
        alertObj.reason.toLowerCase().includes(searchValue)
      );

      if (filteredAlerts.length === 0) {
        modalList.innerHTML = "<li class='text-center p-4 text-muted'><i class='fas fa-search fa-2x mb-2'></i><br>لا توجد إنذارات تطابق البحث أو لا توجد إنذارات بعد.</li>";
      }

      filteredAlerts.forEach((alertObj) => {
        let li = document.createElement("li");
        li.className = "alert-item d-flex flex-column flex-md-row justify-content-between align-items-md-start p-3";

        let violationDisplayName = (violationTypes.find(v => v.id === alertObj.type) || {}).name || alertObj.type;
        let typeClass = 'text-primary';
        if (violationDisplayName.toLowerCase().includes('عقوبة') || violationDisplayName.toLowerCase().includes('خصم')) typeClass = 'text-danger';
        else if (violationDisplayName.toLowerCase().includes('إنذار') || violationDisplayName.toLowerCase().includes('تنبيه') || violationDisplayName.toLowerCase().includes('توبيخ') || violationDisplayName.toLowerCase().includes('لفت نظر')) typeClass = 'text-warning';
        else if (violationDisplayName.toLowerCase().includes('مكافأة') || violationDisplayName.toLowerCase().includes('شكر')) typeClass = 'text-success';


        li.innerHTML = `
          <div class="flex-grow-1 mb-2 mb-md-0 me-md-3">
            <h6 class="mb-1"><strong class="${typeClass}">${violationDisplayName} ${alertObj.typeNumber ? '(' + alertObj.typeNumber + ')' : ''}</strong></h6>
            <p class="mb-1"><strong>الموظف:</strong> ${alertObj.name}</p>
            <p class="mb-1 text-muted small"><em>${alertObj.reason.substring(0,100)}${alertObj.reason.length > 100 ? '...' : ''}</em></p>
            <small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>${alertObj.date}</small>
          </div>
          <div class="btn-group-vertical btn-group-sm mt-2 mt-md-0" role="group" style="min-width: 90px;">
            <button class="btn btn-outline-primary edit-btn" data-id="${alertObj.id}" title="تعديل">
              <i class="fas fa-edit"></i> <span class="d-none d-lg-inline">تعديل</span>
            </button>
            <button class="btn btn-outline-info print-btn" data-id="${alertObj.id}" title="طباعة">
              <i class="fas fa-print"></i> <span class="d-none d-lg-inline">طباعة</span>
            </button>
            <button class="btn btn-outline-danger delete-btn" data-id="${alertObj.id}" title="حذف">
              <i class="fas fa-trash-alt"></i> <span class="d-none d-lg-inline">حذف</span>
            </button>
          </div>
        `;
        modalList.appendChild(li);
      });

      document.querySelectorAll("#alertsModalList .edit-btn").forEach(button => {
        button.addEventListener("click", function() {
          const alertId = this.getAttribute("data-id");
          editAlert(alertId);
          let modal = bootstrap.Modal.getInstance(document.getElementById("alertsModal"));
          if(modal) modal.hide();
        });
      });
      document.querySelectorAll("#alertsModalList .delete-btn").forEach(button => {
        button.addEventListener("click", function() {
          const alertId = this.getAttribute("data-id");
          deleteAlert(alertId);
        });
      });
      document.querySelectorAll("#alertsModalList .print-btn").forEach(button => {
        button.addEventListener("click", function() {
          const alertId = this.getAttribute("data-id");
          const alertToPrint = alerts.find(a => a.id === alertId);
          if (alertToPrint) printAlert(alertToPrint);
        });
      });
    }

    const modalSearchInput = document.getElementById("modalSearchInput");
    if (modalSearchInput) {
        modalSearchInput.addEventListener("input", updateAlertsModalList);
    }

    function attachMainListeners() {
      if(!window.mainListenersAttached){
        if (addBtn) {
            addBtn.addEventListener("click", function() { addAlert(); });
        }
        window.mainListenersAttached = true;
      }
    }
    function goToApp() {
      document.getElementById("welcomeScreen").style.display = "none";
      document.getElementById("app-container").style.display = "block"; 
      attachMainListeners();
      loadAlertsFromLocalStorage();
      updateAlertsModalList();
      document.getElementById("name").focus();
    }
    document.getElementById("backToMenuBtn").addEventListener("click", function() {
      document.getElementById("app-container").style.display = "none";
      document.getElementById("welcomeScreen").style.display = "flex";
    });
    document.getElementById("showAlertsBtn").addEventListener("click", function() {
      updateAlertsModalList();
      let modalEl = document.getElementById("alertsModal");
      let modal = bootstrap.Modal.getInstance(modalEl);
      if (!modal) {
        modal = new bootstrap.Modal(modalEl);
      }
      modal.show();
    });

    document.getElementById("printSuccessBtn").addEventListener("click", function() {
      if(alerts.length > 0) {
        printAlert(alerts[0]);
      }
      else { alert("لا توجد تنبيهات للطباعة. قم بإضافة تنبيه أولاً."); }
    });

    document.getElementById("backupBtn")?.addEventListener("click", function() {
      let backupData = {
        alerts: localStorage.getItem(ALERTS_STORAGE_KEY),
        customPatterns: localStorage.getItem("customPatterns"),
        violationTypes: localStorage.getItem("violationTypes"),
        employeeNames: localStorage.getItem("employeeNames"),
        defaultAIRule: localStorage.getItem("defaultAIRule"),
        printSettings: localStorage.getItem(PRINT_SETTINGS_KEY)
      };
      let dataStr = JSON.stringify(backupData, null, 2);
      let blob = new Blob([dataStr], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      let today = new Date().toISOString().slice(0,10);
      a.download = `EmperMI_backup_${today}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert("تم تنزيل ملف النسخة الاحتياطية بنجاح!");
    });
    document.getElementById("restoreBtn")?.addEventListener("click", function() {
      document.getElementById("restoreFileInput").click();
    });
    document.getElementById("restoreFileInput").addEventListener("change", function(event) {
      let file = event.target.files[0];
      if (!file) return;
      if (!file.name.endsWith('.json')) {
        alert("يرجى اختيار ملف بصيغة JSON.");
        event.target.value = null;
        return;
      }
      let reader = new FileReader();
      reader.onload = function(e) {
        try {
          let backupData = JSON.parse(e.target.result);
          if (typeof backupData.alerts === 'undefined' && typeof backupData.customPatterns === 'undefined') { 
              throw new Error("ملف النسخة الاحتياطية غير صالح أو لا يحتوي على البيانات المتوقعة.");
          }

          if (backupData.alerts) { localStorage.setItem(ALERTS_STORAGE_KEY, backupData.alerts); }
          if (backupData.customPatterns) { localStorage.setItem("customPatterns", backupData.customPatterns); }
          if (backupData.violationTypes) { localStorage.setItem("violationTypes", backupData.violationTypes); }
          if (backupData.employeeNames) { localStorage.setItem("employeeNames", backupData.employeeNames); }
          if (backupData.defaultAIRule) { localStorage.setItem("defaultAIRule", backupData.defaultAIRule); }
          if (backupData.printSettings) { localStorage.setItem(PRINT_SETTINGS_KEY, backupData.printSettings); } 

          loadAllData();
          updateAllUI();

          alert("تم استرجاع البيانات بنجاح. سيتم تحديث الواجهة.");
        } catch (err) {
          console.error("Restore error: ", err);
          alert("خطأ في قراءة ملف النسخة الاحتياطية: " + err.message);
        } finally {
            event.target.value = null;
        }
      };
      reader.readAsText(file);
    });

    function loadAllData() {
        loadAlertsFromLocalStorage();
        loadCustomPatterns();
        loadViolationTypes();
        loadEmployeeNames();
        loadPrintSettings();
        defaultAIRule = localStorage.getItem("defaultAIRule") || "تم توجيه {violationType} للموظف {name} نتيجة العمل الغير جدي، ولذلك تم تطبيق عقوبة. نرجو منكم الإلتزام بالقوانين الخاصة بشركتنا لتجنب تكرار هذه المخالفات.";
    }

    function updateAllUI() {
        updateAlertsModalList();
        updateCustomPatternsList();
        updateReasonModeDropdown();
        updateViolationTypesList();
        updateViolationTypeDropdown();
        updateEmployeeDatalist();
        updateEmployeeList();
        loadPrintSettings(); 

        const reasonModeSelect = document.getElementById("reasonMode");
        if (reasonModeSelect) {
            reasonModeSelect.dispatchEvent(new Event('change'));
        }

        const nameField = document.getElementById("name");
        if (nameField && nameField.value.trim() && reasonModeSelect && reasonModeSelect.value === "ai") {
            const aiReasonField = document.getElementById("aiReason");
            if (aiReasonField) aiReasonField.value = generateAIReason();
        }
    }

    (function createRestoreInput() {
      if (!document.getElementById("restoreFileInput")) {
        let input = document.createElement("input");
        input.type = "file";
        input.id = "restoreFileInput";
        input.style.display = "none";
        input.accept = ".json";
        document.body.appendChild(input);
      }
    })();
    let violationTypes = [];
    const DEFAULT_VIOLATION_TYPES = [
        { id: "default_warning_main", name: "إنذار" }
    ];
    function loadViolationTypes() {
      let data = localStorage.getItem("violationTypes");
      if (data) {
        try {
            violationTypes = JSON.parse(data);
            if (!Array.isArray(violationTypes) || violationTypes.some(vt => typeof vt.id === 'undefined' || typeof vt.name === 'undefined')) {
                 violationTypes = [...DEFAULT_VIOLATION_TYPES];
                 saveViolationTypes();
            }
            if (violationTypes.length === 0) {
                 violationTypes = [...DEFAULT_VIOLATION_TYPES];
                 saveViolationTypes();
            }
        } catch (e) {
            violationTypes = [...DEFAULT_VIOLATION_TYPES];
            saveViolationTypes();
        }
      } else {
        violationTypes = [...DEFAULT_VIOLATION_TYPES];
        saveViolationTypes();
      }
    }
    function saveViolationTypes() {
      localStorage.setItem("violationTypes", JSON.stringify(violationTypes));
    }
    function updateViolationTypeDropdown() {
      let typeSelect = document.getElementById("type");
      if (typeSelect) {
        let currentSelection = typeSelect.value;
        typeSelect.innerHTML = "";
        violationTypes.forEach(vt => {
          let option = document.createElement("option");
          option.value = vt.id;
          option.text = vt.name;
          typeSelect.appendChild(option);
        });
        if (violationTypes.some(vt => vt.id === currentSelection)) {
            typeSelect.value = currentSelection;
        } else if (typeSelect.options.length > 0) {
            typeSelect.selectedIndex = 0;
        }
      }
    }
    function updateViolationTypesList() {
      let listDiv = document.getElementById("violationTypesList");
      if (!listDiv) return;
      listDiv.innerHTML = "";
      if (violationTypes.length === 0) {
        listDiv.innerHTML = "<p class='text-muted text-center p-3'><i class='fas fa-folder-open fa-2x mb-2'></i><br>لا توجد أنواع مخالفات معرفة.</p>";
      } else {
        violationTypes.forEach(vt => {
            let div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-light";
            div.innerHTML = `
            <span class="fw-bold">${vt.name}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteViolationType('${vt.id}')" title="حذف نوع المخالفة">
                <i class="fas fa-trash-alt"></i>
            </button>
            `;
            listDiv.appendChild(div);
        });
      }
    }

    function deleteViolationType(idToDelete) {
      if (alerts.some(alert => alert.type === idToDelete)) {
        alert("لا يمكن حذف نوع المخالفة هذا لأنه مستخدم في تنبيهات حالية. يرجى تعديل أو حذف التنبيهات المرتبطة أولاً.");
        return;
      }
      if (!confirm(`هل أنت متأكد من حذف نوع المخالفة هذا؟`)) return;
      violationTypes = violationTypes.filter(vt => vt.id !== idToDelete);
      saveViolationTypes();
      updateViolationTypesList();
      updateViolationTypeDropdown();
    }
    let employeeNames = [];
    function loadEmployeeNames() {
      let data = localStorage.getItem("employeeNames");
      employeeNames = data ? JSON.parse(data) : [];
      if (!Array.isArray(employeeNames)) employeeNames = [];
    }
    function saveEmployeeNames() {
      localStorage.setItem("employeeNames", JSON.stringify(employeeNames));
    }
    function updateEmployeeDatalist() {
      let datalist = document.getElementById("employeeList");
      if (!datalist) return;
      datalist.innerHTML = "";
      employeeNames.forEach(name => {
        let option = document.createElement("option");
        option.value = name;
        datalist.appendChild(option);
      });
    }
    function updateEmployeeList() {
      let listDiv = document.getElementById("employeeListDiv");
      if (!listDiv) return;
      listDiv.innerHTML = "";
      if (employeeNames.length === 0) {
          listDiv.innerHTML = "<p class='text-muted text-center p-3'><i class='fas fa-users-slash fa-2x mb-2'></i><br>لا يوجد موظفون مضافون للقائمة المقترحة.</p>";
      } else {
        employeeNames.forEach((name, index) => {
            let div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-light";
            div.innerHTML = `<span class="fw-bold">${name}</span><button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${index})" title="حذف الموظف من القائمة"><i class="fas fa-user-minus"></i></button>`;
            listDiv.appendChild(div);
        });
      }
    }
    function addEmployee() {
      let newNameInput = document.getElementById("newEmployeeName");
      let newName = newNameInput.value.trim();
      if(newName === "") { alert("يرجى إدخال اسم الموظف"); newNameInput.focus(); return; }
      if (employeeNames.some(name => name.toLowerCase() === newName.toLowerCase())) {
          alert("اسم الموظف موجود بالفعل في القائمة.");
          newNameInput.focus();
          return;
      }
      employeeNames.push(newName);
      employeeNames.sort((a, b) => a.localeCompare(b, 'ar'));
      saveEmployeeNames();
      updateEmployeeDatalist();
      updateEmployeeList();
      newNameInput.value = "";
      newNameInput.focus();
    }
    function deleteEmployee(index) {
      const employeeNameToDelete = employeeNames[index];
      if(!confirm(`هل أنت متأكد من حذف الموظف "${employeeNameToDelete}" من قائمة الاقتراحات؟`)){
            return;
      }
      employeeNames.splice(index, 1);
      saveEmployeeNames();
      updateEmployeeDatalist();
      updateEmployeeList();
    }

    const SMART_ANALYSIS_THRESHOLD = 3;
    const NEGATIVE_VIOLATION_KEYWORDS = ["إنذار", "عقوبة", "خصم", "توبيخ", "لفت نظر"];

    function displayEmployeeMonitoring() {
        const employeeListContainer = document.getElementById("employeeMonitoringList");
        const searchInput = document.getElementById("analysisSearchInput");
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

        if (!employeeListContainer) {
            console.error("Employee monitoring list container not found!");
            return;
        }

        employeeListContainer.innerHTML = '<p class="text-center text-info p-3"><i class="fas fa-spinner fa-spin"></i> جاري تحميل قائمة الموظفين...</p>';

        const filteredEmployeeNames = employeeNames.filter(name => name.toLowerCase().includes(searchTerm));

        if (filteredEmployeeNames.length === 0 && employeeNames.length > 0) {
            employeeListContainer.innerHTML = '<p class="text-center text-muted p-4"><i class="fas fa-search-minus"></i> لا يوجد موظفون يطابقون بحثك.</p>';
            return;
        }
        if (employeeNames.length === 0) {
            employeeListContainer.innerHTML = '<p class="text-center text-muted p-4"><i class="fas fa-users-slash fa-2x mb-2"></i><br>لا يوجد موظفون مسجلون في قائمة الاقتراحات بعد.<br><small>قم بإضافة موظفين من الإعدادات أو عند إضافة إنذار جديد.</small></p>';
            return;
        }

        const allEmployeeNegativeAlertsCount = alerts.reduce((acc, alert) => {
            const violationTypeObj = violationTypes.find(vt => vt.id === alert.type);
            if (violationTypeObj && violationTypeObj.name) {
                const isNegative = NEGATIVE_VIOLATION_KEYWORDS.some(keyword =>
                    violationTypeObj.name.toLowerCase().includes(keyword.toLowerCase())
                );
                if (isNegative) {
                    acc[alert.name] = (acc[alert.name] || 0) + 1;
                }
            }
            return acc;
        }, {});


        let listHTML = '<ul class="list-group">';
        filteredEmployeeNames.forEach(empName => {
            const count = allEmployeeNegativeAlertsCount[empName] || 0;
            let itemClass = "list-group-item";
            let badgeClass = "bg-secondary";
            let detailButtonHTML = "";

            if (count >= SMART_ANALYSIS_THRESHOLD) {
                itemClass += " list-group-item-danger";
                badgeClass = "bg-danger";
                detailButtonHTML = `<button class="btn btn-sm btn-warning show-analysis-detail-btn" data-employee-name="${empName}" data-violation-count="${count}" title="عرض تفاصيل التحليل"><i class="fas fa-search-plus"></i> عرض التفاصيل</button>`;
            } else if (count > 0) {
                badgeClass = "bg-warning text-dark";
            }


            listHTML += `
                <li class="${itemClass}">
                    <span class="employee-name">${empName}</span>
                    <div>
                        <span class="badge rounded-pill violation-count me-2 ${badgeClass}">${count} مخالفات</span>
                        ${detailButtonHTML}
                    </div>
                </li>
            `;
        });
        listHTML += '</ul>';
        employeeListContainer.innerHTML = listHTML;

        document.querySelectorAll('.show-analysis-detail-btn').forEach(button => {
            button.addEventListener('click', function() {
                const employeeName = this.getAttribute('data-employee-name');
                const violationCount = parseInt(this.getAttribute('data-violation-count'), 10);
                showEmployeeAnalysisDetail(employeeName, violationCount);
            });
        });
    }

    function showEmployeeAnalysisDetail(employeeName, violationCount) {
        const detailContentEl = document.getElementById("employeeAnalysisDetailContent");
        const detailModalEl = document.getElementById("employeeAnalysisDetailModal");
        const detailModalLabel = document.getElementById("employeeAnalysisDetailModalLabel");

        if (!detailContentEl || !detailModalEl || !detailModalLabel) {
            console.error("Detail modal elements not found!");
            return;
        }

        detailModalLabel.innerHTML = `<i class="fas fa-exclamation-triangle"></i> تفاصيل تحليل الموظف: ${employeeName}`;

        const smsWarningText = `تحذير: تم تسجيل ${violationCount} مخالفات باسمك (${employeeName}). قد يؤثر هذا على استمراريتك في العمل. يرجى مراجعة الإدارة.`;

        detailContentEl.innerHTML = `
            <div class="employee-analysis-card">
                <h5 class="mb-2"><i class="fas fa-user-tie text-danger"></i> الموظف: ${employeeName}</h5>
                <p class="mb-1"><strong>عدد المخالفات السلبية المسجلة:</strong> <span class="badge bg-danger fs-6">${violationCount}</span></p>
                <p class="text-danger fw-bold mt-2"><i class="fas fa-exclamation-triangle"></i> تحذير: ربما قد تُطرد من العمل بسبب تكرار المخالفات.</p>

                <div class="sms-simulation-box mt-3">
                    <p class="sms-to-maryam"><i class="fas fa-mobile-alt"></i> الآنسة مريم، رجاءً تصرفي الآن وقومي بإرسال رسالة نصية لهذا الموظف تتضمن التحذير التالي (يمكنك نسخ النص بالضغط عليه):</p>
                    <div class="sms-content-to-copy" title="اضغط لنسخ النص" onclick="copyToClipboard(this)">${smsWarningText}</div>
                </div>
            </div>
        `;

        let modalInstance = bootstrap.Modal.getInstance(detailModalEl);
        if (!modalInstance) {
            modalInstance = new bootstrap.Modal(detailModalEl);
        }
        modalInstance.show();
    }

    function copyToClipboard(element) {
        const textToCopy = element.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = element.innerHTML;
            const checkIcon = ' <i class="fas fa-check text-success"></i>';
            element.innerHTML = 'تم النسخ!' + checkIcon;
            setTimeout(() => {
                element.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('فشل نسخ النص. يرجى نسخه يدوياً.');
        });
    }

    function resetSystem() {
        const confirmationMessage = "تحذير خطير!\n\n" +
                                "أنت على وشك إعادة تهيئة النظام بالكامل.\n" +
                                "سيؤدي هذا إلى حذف جميع البيانات التالية بشكل نهائي:\n" +
                                "- جميع الإنذارات والعقوبات المسجلة.\n" +
                                "- جميع الأنماط المخصصة.\n" +
                                "- جميع أنواع المخالفات المخصصة.\n" +
                                "- جميع أسماء الموظفين المقترحة.\n" +
                                "- نمط الذكاء الاصطناعي المخصص.\n" +
                                "- إعدادات الطباعة المخصصة.\n\n" +
                                "لا يمكن التراجع عن هذا الإجراء. هل أنت متأكد تمامًا من رغبتك في المتابعة؟";

        if (confirm(confirmationMessage)) {
            if (confirm("للتأكيد مرة أخرى: هل أنت متأكد 100% من أنك تريد حذف كل شيء وإعادة النظام إلى حالته الافتراضية؟")) {

                localStorage.removeItem(ALERTS_STORAGE_KEY);
                localStorage.removeItem("customPatterns");
                localStorage.removeItem("violationTypes");
                localStorage.removeItem("employeeNames");
                localStorage.removeItem("defaultAIRule");
                localStorage.removeItem(PRINT_SETTINGS_KEY);

                alerts = [];
                customPatterns = [];
                violationTypes = [];
                employeeNames = [];
                defaultAIRule = "تم توجيه {violationType} للموظف {name} نتيجة العمل الغير جدي، ولذلك تم تطبيق عقوبة. نرجو منكم الإلتزام بالقوانين الخاصة بشركتنا لتجنب تكرار هذه المخالفات.";
                editingPatternId = null;
                editingIndex = -1;
                
                loadAllData(); 
                updateAllUI();

                if (document.getElementById("app-container").style.display === "block") {
                    nameInput.value = "";
                    document.getElementById("aiReason").value = "";
                    document.getElementById("manualReason").value = "";
                    typeNumberInput.value = "";
                    const typeSelect = document.getElementById("type");
                    if (typeSelect.options.length > 0) typeSelect.selectedIndex = 0;
                    document.getElementById("reasonMode").value = "manual";
                    document.getElementById("reasonMode").dispatchEvent(new Event('change'));
                }

                alert("تمت إعادة تهيئة النظام بنجاح. تم حذف جميع البيانات وعاد النظام إلى الإعدادات الافتراضية، بما في ذلك إعدادات الطباعة.");

                let settingsModalEl = document.getElementById("settingsModal");
                let settingsModal = bootstrap.Modal.getInstance(settingsModalEl);
                if (settingsModal) {
                    settingsModal.hide();
                }
            } else {
                alert("تم إلغاء عملية إعادة تهيئة النظام.");
            }
        } else {
            alert("تم إلغاء عملية إعادة تهيئة النظام.");
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
      const splashScreen = document.getElementById('splashScreen');
      const originalWelcomeScreen = document.getElementById('welcomeScreen');
      const appContainer = document.getElementById('app-container');

      if (splashScreen) splashScreen.style.display = 'flex'; 
      if (originalWelcomeScreen) originalWelcomeScreen.style.display = 'none';
      if (appContainer) appContainer.style.display = 'none';

      setTimeout(() => {
          if (splashScreen) {
              splashScreen.classList.add('hidden'); 
              setTimeout(() => {
                  splashScreen.style.display = 'none';
                  if (originalWelcomeScreen) {
                      originalWelcomeScreen.style.display = 'flex'; 
                  } else if (appContainer) { 
                      appContainer.style.display = 'block';
                  }
              }, 700); 
          } else {
              if (originalWelcomeScreen) {
                originalWelcomeScreen.style.display = 'flex';
              } else if (appContainer) {
                appContainer.style.display = 'block';
              }
          }
      }, 3000); 

      loadAllData();
      updateAllUI();
      attachMainListeners();

      const addPattBtn = document.getElementById("addPatternBtn");
      if(addPattBtn) {
          addPattBtn.addEventListener("click", function(){
            let nameInput = document.getElementById("patternName");
            let textInput = document.getElementById("patternText");
            let name = nameInput.value.trim();
            let text = textInput.value.trim();

            if(!name) { alert("يرجى إدخال اسم النمط."); nameInput.focus(); return; }
            if(!text) { alert("يرجى إدخال نص النمط."); textInput.focus(); return; }

            if(editingPatternId) {
              customPatterns = customPatterns.map(p => {
                if(p.id === editingPatternId) { return { ...p, name: name, text: text }; }
                return p;
              });
              editingPatternId = null;
              addPattBtn.innerHTML = '<i class="fas fa-plus-circle"></i> إضافة النمط';
              alert("تم تعديل النمط بنجاح.");
            } else {
              if (customPatterns.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert("يوجد نمط آخر بنفس الاسم. يرجى اختيار اسم مختلف.");
                nameInput.focus();
                return;
              }
              let pattern = { id: Date.now().toString(), name: name, text: text };
              customPatterns.push(pattern);
              alert("تم إضافة النمط بنجاح.");
            }
            saveCustomPatterns();
            updateCustomPatternsList();
            updateReasonModeDropdown();
            nameInput.value = "";
            textInput.value = "";
            nameInput.focus();
          });
      }

      const addVioTypeBtn = document.getElementById("addViolationTypeBtn");
      if (addVioTypeBtn) {
          addVioTypeBtn.addEventListener("click", function(){
            let newTypeNameInput = document.getElementById("newViolationType");
            let newTypeName = newTypeNameInput.value.trim();
            if (!newTypeName) { alert("يرجى إدخال اسم نوع المخالفة"); newTypeNameInput.focus(); return; }

            let id = "vt_" + newTypeName.toLowerCase().replace(/\s+/g, '_').replace(/[^\w\sأ-ي]/gi, '').replace(/\s/g,'_') + "_" + Date.now().toString().slice(-5);

            if (violationTypes.some(vt => vt.name.toLowerCase() === newTypeName.toLowerCase())) {
                alert("نوع المخالفة بهذا الاسم موجود بالفعل.");
                newTypeNameInput.focus();
                return;
            }
            violationTypes.push({ id, name: newTypeName });
            saveViolationTypes();
            updateViolationTypesList();
            updateViolationTypeDropdown();
            newTypeNameInput.value = "";
            newTypeNameInput.focus();
            alert("تم إضافة نوع المخالفة بنجاح.");
          });
      }

      const addEmpBtn = document.getElementById("addEmployeeBtn");
      if(addEmpBtn) { addEmpBtn.addEventListener("click", addEmployee); }

      const reasonModeSelectInit = document.getElementById("reasonMode");
        if (reasonModeSelectInit) {
            reasonModeSelectInit.dispatchEvent(new Event('change'));
        }

      const employeeMonitoringButton = document.getElementById("smartAnalysisBtn");
      if (employeeMonitoringButton) {
          employeeMonitoringButton.addEventListener("click", function() {
            displayEmployeeMonitoring();
            let modalEl = document.getElementById("smartAnalysisModal");
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bootstrap.Modal(modalEl);
            }
            modal.show();
          });
      }

      const analysisSearchInputEl = document.getElementById("analysisSearchInput");
      if (analysisSearchInputEl) {
          analysisSearchInputEl.addEventListener("input", function() {
              displayEmployeeMonitoring();
          });
      }

      const resetSystemButton = document.getElementById("resetSystemBtn");
      if (resetSystemButton) {
          resetSystemButton.addEventListener("click", resetSystem);
      }

      const savePrintSettingsButton = document.getElementById("savePrintSettingsBtn");
      if (savePrintSettingsButton) {
          savePrintSettingsButton.addEventListener("click", updateAndSavePrintSettings);
      }

    });
  </script>
</body>
</html>
